---
import Layout from '@components/Layout.astro';
---

<Layout title="Upload Data - Everse Inventory Pro">
  <div class="space-y-6" x-data="{ 
    uploading: false, 
    dragOver: false,
    success: null,
    error: null 
  }">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Upload Data</h1>

    <!-- Drag & Drop Zone -->
    <div
      @dragover.prevent="dragOver = true"
      @dragleave.prevent="dragOver = false"
      @drop.prevent="
        dragOver = false;
        const files = $event.dataTransfer.files;
        if (files.length) handleUpload(files[0]);
      "
      :class="{ 'border-blue-500 bg-blue-50 dark:bg-blue-900/20': dragOver }"
      class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-12 text-center cursor-pointer transition-colors hover:border-blue-400"
      @click="document.getElementById('fileInput').click()"
    >
      <input
        type="file"
        id="fileInput"
        class="hidden"
        accept=".csv,.xlsx,.xls,.txt"
        @change="if ($event.target.files.length) handleUpload($event.target.files[0])"
      />
      <div class="text-6xl mb-4">ğŸ“¤</div>
      <p class="text-xl font-semibold mb-2 text-gray-800 dark:text-gray-200">Drag & Drop Files Here</p>
      <p class="text-gray-600 dark:text-gray-400">
        Supports: CSV, Excel (.xlsx, .xls), and TXT files
      </p>
      <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">Or click to browse</p>
    </div>

    <!-- File Type Selector -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
      <label class="block mb-2 font-semibold text-gray-800 dark:text-gray-200">Data Type</label>
      <select id="dataType" class="w-full border-2 border-gray-300 dark:border-gray-600 rounded-lg p-3 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <option value="inventory">ğŸ“¦ Inventory</option>
        <option value="sales">ğŸ›’ Sales/Orders</option>
        <option value="accounts">ğŸ‘¥ Accounts/Suppliers</option>
        <option value="txt">ğŸ“„ Auto-detect (TXT only)</option>
      </select>
    </div>

    <!-- Template Download Buttons -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">ğŸ“¥ Download CSV/Excel Templates</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">Download sample templates to ensure correct format before uploading your data.</p>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        <a
          href="/api/template?type=inventory"
          class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2 text-center"
        >
          ğŸ“¥ Inventory Template
        </a>
        <a
          href="/api/template?type=sales"
          class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 text-center"
        >
          ğŸ“¥ Sales Template
        </a>
        <a
          href="/api/template?type=accounts"
          class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2 text-center"
        >
          ğŸ“¥ Accounts Template
        </a>
      </div>
    </div>

    <!-- Upload Status -->
    <div x-show="uploading" class="bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4">
      <div class="flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
        <span class="text-blue-800 dark:text-blue-200 font-medium">Uploading and processing...</span>
      </div>
    </div>

    <div
      x-show="success"
      x-text="success"
      class="bg-green-50 dark:bg-green-900/20 border-2 border-green-300 dark:border-green-700 rounded-lg p-4 text-green-800 dark:text-green-200 font-medium"
      style="display: none;"
    ></div>

    <div
      x-show="error"
      x-text="error"
      class="bg-red-50 dark:bg-red-900/20 border-2 border-red-300 dark:border-red-700 rounded-lg p-4 text-red-800 dark:text-red-200 font-medium"
      style="display: none;"
    ></div>
  </div>

  <script is:inline>
    function handleUpload(file) {
      const uploadContainer = document.querySelector('[x-data]');
      if (!uploadContainer || !window.Alpine) {
        alert('Error: Alpine.js not loaded');
        return;
      }

      const uploadData = window.Alpine.$data(uploadContainer);
      if (!uploadData) {
        alert('Error: Could not access component data');
        return;
      }
      
      uploadData.uploading = true;
      uploadData.success = null;
      uploadData.error = null;

      const formData = new FormData();
      formData.append('file', file);
      const dataType = document.getElementById('dataType').value;
      formData.append('type', dataType);

      fetch('/api/upload', {
        method: 'POST',
        body: formData,
      })
        .then((res) => res.json())
        .then((data) => {
          uploadData.uploading = false;
          if (data.success) {
            uploadData.success = `âœ… ${data.message || 'Success'} (${data.imported || 0} records imported)`;
            setTimeout(() => {
              uploadData.success = null;
              if (data.imported) window.location.reload();
            }, 3000);
          } else {
            uploadData.error = `âŒ ${data.error || 'Upload failed'}`;
          }
        })
        .catch((error) => {
          uploadData.uploading = false;
          uploadData.error = `âŒ Upload failed: ${error.message}`;
        });
    }

    // Make handleUpload global
    window.handleUpload = handleUpload;
  </script>
</Layout>

