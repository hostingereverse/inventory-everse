---
import Layout from '@components/Layout.astro';
import DataTable from '@components/DataTable.astro';
import { DB } from '../lib/db';
import { formatCurrency } from '../lib/utils';

const db = Astro.locals.runtime?.env?.DB ? new DB(Astro.locals.runtime.env.DB) : null;
let inventory: any[] = [];
let headers = ['SKU', 'Name', 'Category', 'Warehouse', 'Stock', 'Cost Price', 'Sell Price', 'Reorder Point'];
let rows: any[][] = [];

if (db) {
  try {
    inventory = await db.getInventory();
    rows = inventory.map((item) => [
      item.sku,
      item.name,
      item.category || '-',
      item.warehouse,
      item.stock,
      formatCurrency(item.cost_price),
      formatCurrency(item.sell_price),
      item.reorder_point,
    ]);
  } catch (error) {
    console.error('Error loading inventory:', error);
    rows = [['Error loading data']];
  }
} else {
  rows = [['Database not connected. Please configure D1 database.']];
}
---

<Layout title="Inventory - Everse Inventory Pro">
  <div class="space-y-6">
    <div class="flex justify-between items-center flex-wrap gap-4">
      <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Inventory</h1>
      <div class="flex gap-3 flex-wrap">
        <a
          href="/api/template?type=inventory"
          class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
        >
          ⬇️ Download Template
        </a>
        <button
          onclick="document.getElementById('uploadModal').classList.remove('hidden')"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
        >
          ⬆️ Upload CSV/Excel
        </button>
      </div>
    </div>

    <DataTable headers={headers} rows={rows} />

    <!-- Upload Modal -->
    <div
      id="uploadModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      onclick="if(event.target === this) this.classList.add('hidden')"
    >
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full shadow-xl">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Upload Data</h2>
        <form
          action="/api/upload"
          method="post"
          enctype="multipart/form-data"
          class="space-y-4"
          id="uploadForm"
          onsubmit="handleUploadSubmit(event)"
        >
          <div>
            <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Select File</label>
            <input
              type="file"
              name="file"
              accept=".csv,.xlsx,.xls,.txt"
              required
              class="w-full border-2 border-gray-300 dark:border-gray-600 rounded-lg p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
            />
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Supports: CSV, Excel (.xlsx, .xls), TXT</p>
          </div>
          <div>
            <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">Data Type</label>
            <select name="type" class="w-full border-2 border-gray-300 dark:border-gray-600 rounded-lg p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
              <option value="inventory">Inventory</option>
              <option value="sales">Sales</option>
              <option value="accounts">Accounts/Suppliers</option>
              <option value="txt">Auto-detect (TXT only)</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors"
            >
              ⬆️ Upload
            </button>
            <button
              type="button"
              onclick="document.getElementById('uploadModal').classList.add('hidden')"
              class="flex-1 bg-gray-400 dark:bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors"
            >
              Cancel
            </button>
          </div>
          <div id="uploadStatus" class="hidden mt-4 p-3 rounded-lg"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    async function handleUploadSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const statusDiv = document.getElementById('uploadStatus');
      const submitBtn = form.querySelector('button[type="submit"]');
      
      statusDiv.classList.remove('hidden');
      statusDiv.className = 'mt-4 p-3 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200';
      statusDiv.innerHTML = '⏳ Uploading and processing...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
          statusDiv.innerHTML = `✅ ${result.message || `Successfully imported ${result.imported} records`}`;
          form.reset();
          setTimeout(() => {
            document.getElementById('uploadModal').classList.add('hidden');
            window.location.reload();
          }, 2000);
        } else {
          statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
          statusDiv.innerHTML = `❌ Error: ${result.error || 'Upload failed'}`;
        }
      } catch (error) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
        statusDiv.innerHTML = `❌ Upload failed: ${error.message}`;
      } finally {
        submitBtn.disabled = false;
      }
    }
  </script>
</Layout>

