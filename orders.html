<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orders - Everse Inventory Management</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div id="navbar"></div>
  
  <div class="container-fluid mt-4">
    <h1 class="mb-4">Order Management</h1>
    
    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="row g-3">
        <div class="col-md-3">
          <input type="text" class="form-control" id="searchOrderID" placeholder="Search Order ID...">
        </div>
        <div class="col-md-2">
          <input type="date" class="form-control" id="filterDate" placeholder="Filter by Date">
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterStatus">
            <option value="">All Status</option>
            <option value="PROCESSING">Processing</option>
            <option value="FULFILLED">Fulfilled</option>
            <option value="CANCELED">Canceled</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterLocation">
            <option value="">All Locations</option>
          </select>
        </div>
        <div class="col-md-2">
          <input type="text" class="form-control" id="filterSalesPerson" placeholder="Sales Person...">
        </div>
        <div class="col-md-1">
          <button class="btn btn-primary w-100" onclick="applyFilters()">Filter</button>
        </div>
      </div>
    </div>
    
    <!-- New Order Form -->
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="mb-0">New Order</h4>
      </div>
      <div class="card-body">
        <form id="newOrderForm">
          <div class="row g-3">
            <div class="col-md-2">
              <input type="text" class="form-control" id="newOrderID" placeholder="Order ID" required>
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control" id="newOrderDate" required>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="newOrderLocation" required>
                <option value="">Select Location</option>
              </select>
            </div>
            <div class="col-md-2">
              <select class="form-select" id="newOrderProduct" required>
                <option value="">Select Product</option>
              </select>
            </div>
            <div class="col-md-1">
              <input type="number" class="form-control" id="newOrderSP" placeholder="SP" required>
            </div>
            <div class="col-md-1">
              <input type="number" class="form-control" id="newOrderCP" placeholder="CP">
            </div>
            <div class="col-md-1">
              <input type="number" class="form-control" id="newOrderGST" placeholder="GST">
            </div>
            <div class="col-md-1">
              <button type="submit" class="btn btn-primary w-100">Add</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Orders Table -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">All Orders</h4>
        <button class="btn btn-sm btn-light" onclick="exportOrders()">Export CSV</button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Location</th>
                <th>Product</th>
                <th>Status</th>
                <th>SP</th>
                <th>CP</th>
                <th>GST</th>
                <th>Sales Person</th>
                <th>Remarks</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <tr>
                <td colspan="11" class="text-center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  
  <script>
    let allOrders = [];
    let filteredOrders = [];
    
    async function loadOrders() {
      try {
        const data = await initApp();
        allOrders = data.orders || [];
        filteredOrders = [...allOrders];
        
        // Populate location dropdowns
        populateLocations();
        populateProducts(data.inventory);
        
        // Set default date
        document.getElementById('newOrderDate').value = new Date().toISOString().split('T')[0];
        
        renderOrders();
      } catch (error) {
        console.error('Load orders error:', error);
        showToast('Error loading orders', 'danger');
      }
    }
    
    function populateLocations() {
      const selects = ['filterLocation', 'newOrderLocation'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        select.innerHTML = '<option value="">All Locations</option>';
        CONFIG.WAREHOUSES.forEach(wh => {
          const option = document.createElement('option');
          option.value = wh;
          option.textContent = wh;
          select.appendChild(option);
        });
      });
    }
    
    function populateProducts(inventory) {
      const select = document.getElementById('newOrderProduct');
      if (!select) return;
      select.innerHTML = '<option value="">Select Product</option>';
      (inventory || []).forEach(product => {
        const option = document.createElement('option');
        option.value = product.name;
        option.textContent = product.name;
        select.appendChild(option);
      });
    }
    
    function applyFilters() {
      const orderID = document.getElementById('searchOrderID').value.toLowerCase();
      const date = document.getElementById('filterDate').value;
      const status = document.getElementById('filterStatus').value;
      const location = document.getElementById('filterLocation').value;
      const salesPerson = document.getElementById('filterSalesPerson').value.toLowerCase();
      
      filteredOrders = allOrders.filter(order => {
        const orderIDMatch = !orderID || (order.orderid || '').toLowerCase().includes(orderID);
        const dateMatch = !date || (order.date || '').includes(date);
        const statusMatch = !status || (order.status || '').toUpperCase() === status.toUpperCase();
        const locationMatch = !location || 
          (order.deliverylocation || order.deliveryLocation || '').toUpperCase().includes(location.toUpperCase());
        const salesPersonMatch = !salesPerson || 
          (order.salesperson || '').toLowerCase().includes(salesPerson);
        
        return orderIDMatch && dateMatch && statusMatch && locationMatch && salesPersonMatch;
      });
      
      renderOrders();
    }
    
    function renderOrders() {
      const tbody = document.getElementById('ordersTable');
      if (!tbody) return;
      
      if (filteredOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">No orders found</td></tr>';
        return;
      }
      
      tbody.innerHTML = filteredOrders.map(order => {
        const status = (order.status || '').toUpperCase();
        const statusClass = status === 'PROCESSING' ? 'status-processing' : 
                           status === 'FULFILLED' ? 'status-fulfilled' : 'status-canceled';
        return `
          <tr>
            <td>${order.orderid || ''}</td>
            <td>${order.date || ''}</td>
            <td>${order.deliverylocation || order.deliveryLocation || ''}</td>
            <td>${order.product || ''}</td>
            <td><span class="badge ${statusClass}">${status}</span></td>
            <td>${formatCurrency(order.sp || 0)}</td>
            <td>${formatCurrency(order.cp || 0)}</td>
            <td>${formatCurrency(order.gst || 0)}</td>
            <td>${order.salesperson || ''}</td>
            <td>${order.remarks || ''}</td>
            <td>
              ${status === 'PROCESSING' ? 
                `<button class="btn btn-sm btn-success" onclick="fulfillOrder('${order.orderid || ''}')">Fulfill</button>` : 
                ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    async function fulfillOrder(orderID) {
      try {
        const order = allOrders.find(o => o.orderid === orderID);
        if (!order) {
          showToast('Order not found', 'danger');
          return;
        }
        
        const location = order.deliverylocation || order.deliveryLocation || '';
        const warehouse = CONFIG.WAREHOUSES.find(w => 
          location.toUpperCase().includes(w.toUpperCase().substring(0, 3))
        ) || location;
        
        const product = appData.inventory.find(p => 
          p.name === order.product || p.productID === order.product
        );
        
        if (!product) {
          showToast('Product not found', 'danger');
          return;
        }
        
        const qty = 1; // Assuming qty is 1 if not specified
        const stock = product.stock[warehouse] || 0;
        
        if (stock >= qty) {
          // Deduct stock
          await logMovement({
            warehouse: warehouse,
            productID: product.productID,
            type: 'Out',
            qty: qty,
            notes: `Order fulfillment: ${orderID}`,
            user: 'System'
          });
          
          // Update order status
          order.status = 'FULFILLED';
          showToast(`Order ${orderID} fulfilled successfully`, 'success');
          
          // Reload data
          await loadOrders();
        } else {
          // Add to gaps
          await handleGap(order, appData.inventory);
          showToast(`Insufficient stock. Added to gaps.`, 'warning');
        }
      } catch (error) {
        console.error('Fulfill order error:', error);
        showToast('Error fulfilling order', 'danger');
      }
    }
    
    async function exportOrders() {
      exportToCSV(filteredOrders, `orders_${new Date().toISOString().split('T')[0]}.csv`);
      showToast('Orders exported to CSV', 'success');
    }
    
    // New order form submission
    document.getElementById('newOrderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newOrder = {
        orderid: document.getElementById('newOrderID').value,
        date: formatDate(document.getElementById('newOrderDate').value),
        deliverylocation: document.getElementById('newOrderLocation').value,
        product: document.getElementById('newOrderProduct').value,
        status: 'PROCESSING',
        sp: parseFloat(document.getElementById('newOrderSP').value) || 0,
        cp: parseFloat(document.getElementById('newOrderCP').value) || 0,
        gst: parseFloat(document.getElementById('newOrderGST').value) || 0,
        salesperson: '',
        remarks: ''
      };
      
      try {
        const values = [
          newOrder.orderid,
          newOrder.date,
          newOrder.deliverylocation,
          newOrder.product,
          newOrder.status,
          newOrder.sp,
          newOrder.cp,
          newOrder.gst,
          newOrder.salesperson,
          newOrder.remarks
        ];
        
        await saveSheet(CONFIG.SHEETS.ORDERS.range, values, CONFIG.SHEETS.ORDERS.sheetKey);
        showToast('Order added successfully', 'success');
        
        // Reset form
        document.getElementById('newOrderForm').reset();
        document.getElementById('newOrderDate').value = new Date().toISOString().split('T')[0];
        
        // Reload orders
        await loadOrders();
      } catch (error) {
        console.error('Add order error:', error);
        showToast('Error adding order', 'danger');
      }
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', loadOrders);
    
    // Search on input
    document.getElementById('searchOrderID')?.addEventListener('input', applyFilters);
  </script>
</body>
</html>

