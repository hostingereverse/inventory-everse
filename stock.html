<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Management - Everse Inventory Management</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div id="navbar"></div>
  
  <div class="container-fluid mt-4">
    <h1 class="mb-4">Stock Management</h1>
    
    <!-- Stock Entry Form -->
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="mb-0">Stock Movement Entry</h4>
      </div>
      <div class="card-body">
        <form id="stockForm">
          <div class="row g-3">
            <div class="col-md-2">
              <label class="form-label">Warehouse</label>
              <select class="form-select" id="stockWarehouse" required>
                <option value="">Select Warehouse</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Product</label>
              <select class="form-select" id="stockProduct" required>
                <option value="">Select Product</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Type</label>
              <select class="form-select" id="stockType" required>
                <option value="In">In</option>
                <option value="Out">Out</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Quantity</label>
              <input type="number" class="form-control" id="stockQty" min="1" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Notes</label>
              <input type="text" class="form-control" id="stockNotes" placeholder="Optional notes...">
            </div>
            <div class="col-md-12">
              <button type="submit" class="btn btn-primary">Record Movement</button>
            </div>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Stock History Filters -->
    <div class="filter-bar mb-4">
      <div class="row g-3">
        <div class="col-md-2">
          <input type="date" class="form-control" id="filterMovementDate" placeholder="Filter by Date">
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterMovementWarehouse">
            <option value="">All Warehouses</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterMovementType">
            <option value="">All Types</option>
            <option value="In">In</option>
            <option value="Out">Out</option>
          </select>
        </div>
        <div class="col-md-1">
          <button class="btn btn-primary w-100" onclick="applyMovementFilters()">Filter</button>
        </div>
        <div class="col-md-1">
          <button class="btn btn-secondary w-100" onclick="resetMovementFilters()">Reset</button>
        </div>
      </div>
    </div>
    
    <!-- Stock Movements Table -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Stock Movement History</h4>
        <div>
          <span id="movementPageInfo" class="me-3"></span>
          <button class="btn btn-sm btn-light" onclick="exportMovements()">Export CSV</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Warehouse</th>
                <th>Product ID</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>Notes</th>
                <th>User</th>
              </tr>
            </thead>
            <tbody id="movementsTable">
              <tr>
                <td colspan="7" class="text-center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Movements pagination">
          <ul class="pagination justify-content-center" id="movementPagination">
          </ul>
        </nav>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  
  <script>
    let allMovements = [];
    let filteredMovements = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    
    async function loadStock() {
      try {
        const data = await initApp();
        allMovements = data.movements || [];
        filteredMovements = [...allMovements];
        
        // Sort by date descending
        filteredMovements.sort((a, b) => {
          const dateA = new Date(a.date || '1970-01-01');
          const dateB = new Date(b.date || '1970-01-01');
          return dateB - dateA;
        });
        
        populateWarehouses();
        populateProducts(data.inventory);
        renderMovements();
      } catch (error) {
        console.error('Load stock error:', error);
        showToast('Error loading stock movements', 'danger');
      }
    }
    
    function populateWarehouses() {
      const selects = ['stockWarehouse', 'filterMovementWarehouse'];
      selects.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        const isFirst = id === 'stockWarehouse';
        select.innerHTML = isFirst ? '<option value="">Select Warehouse</option>' : '<option value="">All Warehouses</option>';
        CONFIG.WAREHOUSES.forEach(wh => {
          const option = document.createElement('option');
          option.value = wh;
          option.textContent = wh;
          select.appendChild(option);
        });
      });
    }
    
    function populateProducts(inventory) {
      const select = document.getElementById('stockProduct');
      if (!select) return;
      select.innerHTML = '<option value="">Select Product</option>';
      (inventory || []).forEach(product => {
        const option = document.createElement('option');
        option.value = product.productID;
        option.textContent = `${product.name} (${product.productID})`;
        select.appendChild(option);
      });
    }
    
    function applyMovementFilters() {
      const date = document.getElementById('filterMovementDate').value;
      const warehouse = document.getElementById('filterMovementWarehouse').value;
      const type = document.getElementById('filterMovementType').value;
      
      filteredMovements = allMovements.filter(movement => {
        const dateMatch = !date || (movement.date || '').includes(date);
        const warehouseMatch = !warehouse || (movement.warehouse || '').toUpperCase() === warehouse.toUpperCase();
        const typeMatch = !type || (movement.type || '').toUpperCase() === type.toUpperCase();
        
        return dateMatch && warehouseMatch && typeMatch;
      });
      
      filteredMovements.sort((a, b) => {
        const dateA = new Date(a.date || '1970-01-01');
        const dateB = new Date(b.date || '1970-01-01');
        return dateB - dateA;
      });
      
      currentPage = 1;
      renderMovements();
    }
    
    function resetMovementFilters() {
      document.getElementById('filterMovementDate').value = '';
      document.getElementById('filterMovementWarehouse').value = '';
      document.getElementById('filterMovementType').value = '';
      filteredMovements = [...allMovements];
      currentPage = 1;
      renderMovements();
    }
    
    function renderMovements() {
      const tbody = document.getElementById('movementsTable');
      if (!tbody) return;
      
      const startIdx = (currentPage - 1) * itemsPerPage;
      const endIdx = startIdx + itemsPerPage;
      const pageMovements = filteredMovements.slice(startIdx, endIdx);
      
      if (pageMovements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No movements found</td></tr>';
        document.getElementById('movementPageInfo').textContent = '';
        renderPagination(0);
        return;
      }
      
      tbody.innerHTML = pageMovements.map(movement => {
        const typeClass = movement.type === 'In' ? 'status-fulfilled' : 'status-processing';
        return `
          <tr>
            <td>${movement.date || ''}</td>
            <td>${movement.warehouse || ''}</td>
            <td>${movement.productid || movement.productID || ''}</td>
            <td><span class="badge ${typeClass}">${movement.type || ''}</span></td>
            <td>${movement.qty || movement.qty || ''}</td>
            <td>${movement.notes || ''}</td>
            <td>${movement.user || ''}</td>
          </tr>
        `;
      }).join('');
      
      // Update page info
      const totalPages = Math.ceil(filteredMovements.length / itemsPerPage);
      document.getElementById('movementPageInfo').textContent = 
        `Page ${currentPage} of ${totalPages} (${filteredMovements.length} total)`;
      
      renderPagination(totalPages);
    }
    
    function renderPagination(totalPages) {
      const pagination = document.getElementById('movementPagination');
      if (!pagination) return;
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // Previous button
      html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
      </li>`;
      
      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
          </li>`;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
      }
      
      // Next button
      html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
      </li>`;
      
      pagination.innerHTML = html;
    }
    
    function changePage(page) {
      const totalPages = Math.ceil(filteredMovements.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderMovements();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    async function exportMovements() {
      exportToCSV(filteredMovements, `stock_movements_${new Date().toISOString().split('T')[0]}.csv`);
      showToast('Movements exported to CSV', 'success');
    }
    
    // Stock form submission
    document.getElementById('stockForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const movement = {
        warehouse: document.getElementById('stockWarehouse').value,
        productID: document.getElementById('stockProduct').value,
        type: document.getElementById('stockType').value,
        qty: parseInt(document.getElementById('stockQty').value),
        notes: document.getElementById('stockNotes').value || '',
        user: 'User' // Could be replaced with actual user from auth
      };
      
      try {
        const result = await logMovement(movement);
        if (result.success) {
          showToast('Stock movement recorded successfully', 'success');
          
          // Reset form
          document.getElementById('stockForm').reset();
          
          // Reload movements
          await loadStock();
        } else {
          showToast('Error recording movement: ' + (result.error || 'Unknown error'), 'danger');
        }
      } catch (error) {
        console.error('Stock movement error:', error);
        showToast('Error recording movement', 'danger');
      }
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', loadStock);
  </script>
</body>
</html>

