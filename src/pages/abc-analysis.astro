---
import Layout from '@components/Layout.astro';
import { DB } from '../lib/db';
import { performABCAnalysis, performXYZAnalysis } from '../lib/abc-analysis';
import { formatCurrency } from '../lib/utils';

const db = Astro.locals.runtime?.env?.DB ? new DB(Astro.locals.runtime.env.DB) : null;
let inventory: any[] = [];
let sales: any[] = [];
let combined: any[] = [];

if (db) {
  try {
    inventory = await db.getInventory();
    sales = await db.getSales();
    const abc = await performABCAnalysis(db, sales, inventory);
    const xyz = await performXYZAnalysis(db, sales, inventory);

    // Combine ABC and XYZ
    combined = abc.map((abcItem) => {
      const xyzItem = xyz.find((x) => x.product.id === abcItem.product.id);
      return {
        ...abcItem,
        xyzClassification: xyzItem?.classification || 'Z',
        coefficientOfVariation: xyzItem?.coefficientOfVariation || 0,
      };
    });
  } catch (error) {
    console.error('Error loading ABC analysis:', error);
  }
}
---

<Layout title="ABC/XYZ Analysis - Everse Inventory Pro">
  <div class="space-y-6">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">ABC & XYZ Analysis</h1>

    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
      <p class="text-sm">
        <strong>ABC Classification:</strong> A = 80% value, B = 15%, C = 5%<br>
        <strong>XYZ Classification:</strong> X = Low variability, Y = Moderate, Z = High variability
      </p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="bg-gray-100 dark:bg-gray-700 border-b">
            <th class="text-left p-3">SKU</th>
            <th class="text-left p-3">Product</th>
            <th class="text-right p-3">Annual Value</th>
            <th class="text-right p-3">Cumulative %</th>
            <th class="text-center p-3">ABC</th>
            <th class="text-center p-3">XYZ</th>
            <th class="text-center p-3">Strategy</th>
          </tr>
        </thead>
        <tbody>
          {combined.length > 0 ? (
            combined.map((item) => {
              const strategy =
                item.classification === 'A' && item.xyzClassification === 'X'
                  ? 'High Priority'
                  : item.classification === 'A' && item.xyzClassification === 'Y'
                  ? 'Regular Review'
                  : item.classification === 'B'
                  ? 'Moderate Priority'
                  : 'Low Priority';

              const abcColor =
                item.classification === 'A'
                  ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                  : item.classification === 'B'
                  ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'
                  : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';

              return (
                <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-700">
                  <td class="p-3">{item.product.sku}</td>
                  <td class="p-3">{item.product.name}</td>
                  <td class="p-3 text-right">{formatCurrency(item.annualValue)}</td>
                  <td class="p-3 text-right">{item.cumulativePercentage.toFixed(1)}%</td>
                  <td class="p-3 text-center">
                    <span class={`px-2 py-1 rounded font-semibold ${abcColor}`}>
                      {item.classification}
                    </span>
                  </td>
                  <td class="p-3 text-center">
                    <span
                      class={`px-2 py-1 rounded font-semibold ${
                        item.xyzClassification === 'X'
                          ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                          : item.xyzClassification === 'Y'
                          ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200'
                          : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                      }`}
                    >
                      {item.xyzClassification}
                    </span>
                  </td>
                  <td class="p-3 text-center text-sm">{strategy}</td>
                </tr>
              );
            })
          ) : (
            <tr>
              <td colspan="7" class="p-4 text-center text-gray-500">
                No data available. Please import inventory and sales data.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>
</Layout>

