<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Everse Inventory Management</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <!-- Chart.js - Load async for better performance -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous" defer></script>
</head>
<body>
  <!-- Navbar -->
  <div id="navbar"></div>
  
  <div class="container-fluid mt-4">
    <h1 class="mb-4">Dashboard</h1>
    
    <!-- KPI Cards -->
    <div class="row" id="kpiRow">
      <div class="col-md-3">
        <div class="kpi-card">
          <p>Total Inventory Value</p>
          <h3 id="totalValue">â‚¹0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card" id="lowStockCard">
          <p>Low Stock Items</p>
          <h3 id="lowStock">0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card" id="noStockCard">
          <p>No Stock Items</p>
          <h3 id="noStock">0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <p>Pending Orders</p>
          <h3 id="unfulfilled">0</h3>
        </div>
      </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="chart-container">
          <h4>Sales by Location</h4>
          <canvas id="salesChart"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="chart-container">
          <h4>Stock per Warehouse</h4>
          <canvas id="stockChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Recent Orders -->
    <div class="card mt-4">
      <div class="card-header">
        <h4 class="mb-0">Recent Orders</h4>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Location</th>
                <th>Product</th>
                <th>Status</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="recentOrdersTable">
              <tr>
                <td colspan="6" class="text-center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Authentication -->
  <script src="auth-config.js"></script>
  <script src="auth.js"></script>
  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Config -->
  <script src="config.js"></script>
  <!-- API Helper -->
  <script src="js/api.js"></script>
  <!-- App Utils -->
  <script src="js/app.js"></script>
  
  <script>
    let salesChart, stockChart;
    
    // Wait for Chart.js to load
    function waitForChart() {
      return new Promise((resolve) => {
        if (typeof Chart !== 'undefined') {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (typeof Chart !== 'undefined') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    }
    
    async function loadDashboard() {
      await waitForChart();
      try {
        const data = await initApp();
        
        // Calculate KPIs
        const kpis = calculateKPIs();
        
        // Update KPI cards
        const totalValue = Object.values(kpis.totalValue).reduce((a, b) => a + b, 0);
        document.getElementById('totalValue').textContent = formatCurrency(totalValue);
        document.getElementById('lowStock').textContent = kpis.lowStock;
        document.getElementById('noStock').textContent = kpis.noStock;
        document.getElementById('unfulfilled').textContent = kpis.unfulfilled;
        
        // Alert styling
        if (kpis.lowStock > 5) {
          document.getElementById('lowStockCard').classList.add('alert-low');
        }
        if (kpis.noStock > 0) {
          document.getElementById('noStockCard').classList.add('alert-low');
        }
        
        // Render charts
        renderSalesChart(data.orders);
        renderStockChart(data.inventory);
        
        // Render recent orders
        renderRecentOrders(data.orders.slice(0, 5));
        
      } catch (error) {
        console.error('Dashboard load error:', error);
        showToast('Error loading dashboard', 'danger');
      }
    }
    
    function renderSalesChart(orders) {
      const ctx = document.getElementById('salesChart');
      if (!ctx) return;
      
      // Group by location
      const locationCounts = {};
      orders.forEach(order => {
        const loc = order.deliverylocation || order.deliveryLocation || 'Unknown';
        locationCounts[loc] = (locationCounts[loc] || 0) + 1;
      });
      
      // Filter: Remove locations with count below 3
      const filteredLocationCounts = {};
      Object.keys(locationCounts).forEach(loc => {
        if (locationCounts[loc] >= 3) {
          filteredLocationCounts[loc] = locationCounts[loc];
        }
      });
      
      if (salesChart) salesChart.destroy();
      
      salesChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(filteredLocationCounts),
          datasets: [{
            data: Object.values(filteredLocationCounts),
            backgroundColor: [
              '#667eea',
              '#764ba2',
              '#f093fb',
              '#f5576c',
              '#4facfe',
              '#00f2fe'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    function renderStockChart(inventory) {
      const ctx = document.getElementById('stockChart');
      if (!ctx) return;
      
      // Calculate current stock per warehouse (total, rounded)
      const warehouseStocks = {};
      CONFIG.WAREHOUSES.forEach(wh => {
        const totalStock = inventory.reduce((sum, p) => {
          return sum + (p.stock[wh] || 0);
        }, 0);
        warehouseStocks[wh] = Math.round(totalStock);
      });
      
      if (stockChart) stockChart.destroy();
      
      stockChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(warehouseStocks),
          datasets: [{
            label: 'Current Stock',
            data: Object.values(warehouseStocks),
            backgroundColor: '#667eea',
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                callback: function(value) {
                  return Math.round(value);
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Current Stock: ${Math.round(context.parsed.y)} units`;
                }
              }
            }
          }
        }
      });
    }
    
    function renderRecentOrders(orders) {
      const tbody = document.getElementById('recentOrdersTable');
      if (!tbody) return;
      
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No orders found</td></tr>';
        return;
      }
      
      tbody.innerHTML = orders.map(order => {
        const status = (order.status || '').toUpperCase();
        const statusClass = status === 'PROCESSING' ? 'status-processing' : 
                           status === 'FULFILLED' ? 'status-fulfilled' : 'status-canceled';
        return `
          <tr>
            <td>${order.orderid || ''}</td>
            <td>${order.date || ''}</td>
            <td>${order.deliverylocation || order.deliveryLocation || ''}</td>
            <td>${order.product || ''}</td>
            <td><span class="badge ${statusClass}">${status}</span></td>
            <td>${formatCurrency(order.sp || 0)}</td>
          </tr>
        `;
      }).join('');
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>
</html>

