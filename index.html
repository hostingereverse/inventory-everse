<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Everse Inventory Management</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <!-- Chart.js - Load async for better performance -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous" defer></script>
</head>
<body>
  <!-- Navbar -->
  <div id="navbar"></div>
  
  <div class="container-fluid mt-4">
    <h1 class="mb-4">Dashboard</h1>
    
    <!-- KPI Cards -->
    <div class="row" id="kpiRow">
      <div class="col-md-3">
        <div class="kpi-card">
          <p>Total Inventory Value</p>
          <h3 id="totalValue">â‚¹0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <p>Total Items</p>
          <h3 id="totalNumber">0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card" id="totalGapsCard">
          <p>Total Gaps</p>
          <h3 id="totalGaps">0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <p>Pending Orders</p>
          <h3 id="pendingOrders">0</h3>
        </div>
      </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="chart-container">
          <h4>Sales by Location</h4>
          <canvas id="salesChart"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="chart-container">
          <h4>Stock per Warehouse</h4>
          <canvas id="stockChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Gaps and Products to Procure -->
    <div class="row mt-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Gaps (Unfulfilled Orders)</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Location</th>
                    <th>Pending Qty</th>
                  </tr>
                </thead>
                <tbody id="gapsTable">
                  <tr>
                    <td colspan="3" class="text-center">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Products to Procure (Variant Wise)</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Location</th>
                    <th>Qty Needed</th>
                  </tr>
                </thead>
                <tbody id="procurementTable">
                  <tr>
                    <td colspan="3" class="text-center">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Config -->
  <script src="config.js"></script>
  <!-- Authentication (Legacy - fallback) -->
  <script src="auth-config.js"></script>
  <script src="auth.js"></script>
  <!-- Google Auth (New System) -->
  <script src="js/google-auth.js"></script>
  <!-- Audit Trail -->
  <script src="js/audit-trail.js"></script>
  <!-- Data Persistence -->
  <script src="js/data-persistence.js"></script>
  <!-- Data Loader -->
  <script src="js/data-loader.js"></script>
  <!-- Email Service -->
  <script src="js/email-service.js"></script>
  <!-- API Helper -->
  <script src="js/api.js"></script>
  <!-- App Utils -->
  <script src="js/app.js"></script>
  <script src="js/auto-product.js"></script>
  <!-- App Initialization -->
  <script src="js/init.js"></script>
  
  <script>
    let salesChart, stockChart;
    
    // Wait for Chart.js to load
    function waitForChart() {
      return new Promise((resolve) => {
        if (typeof Chart !== 'undefined') {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (typeof Chart !== 'undefined') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
        }
      });
    }
    
    async function loadDashboard() {
      await waitForChart();
      try {
        // Wait for app initialization
        if (typeof AppInit !== 'undefined') {
          await AppInit.init();
        }
        
        // Use DataLoader if available, otherwise fallback
        let data;
        if (typeof DataLoader !== 'undefined' && DataLoader.loadAllData) {
          data = await DataLoader.loadAllData();
        } else {
          data = await initApp();
        }
        
        // Start real-time polling if on dashboard (will also be started by AppInit, but this ensures it happens)
        // Note: AppInit also starts polling, so this is a fallback
        if (typeof DataLoader !== 'undefined' && DataLoader.startPolling && typeof renderDashboard === 'function') {
          DataLoader.startPolling((updatedData) => {
            // Update UI with new data
            appData = { ...appData, ...updatedData };
            renderDashboard();
          });
        }
        
        // Calculate KPIs
        const kpis = calculateKPIs();
        
        // Update KPI cards
        document.getElementById('totalValue').textContent = formatCurrency(kpis.totalValue);
        document.getElementById('totalNumber').textContent = kpis.totalNumber.toLocaleString();
        document.getElementById('totalGaps').textContent = kpis.totalGaps;
        document.getElementById('pendingOrders').textContent = kpis.pendingOrders;
        
        // Alert styling for gaps
        if (kpis.totalGaps > 0) {
          document.getElementById('totalGapsCard').classList.add('alert-low');
        }
        
        // Render charts
        renderSalesChart(data.orders);
        renderStockChart(data.inventory);
        
        // Render gaps and procurement
        renderGaps(data.gaps);
        renderProcurement(data.gaps, data.inventory);
        
      } catch (error) {
        console.error('Dashboard load error:', error);
        showToast('Error loading dashboard', 'danger');
      }
    }
    
    function renderSalesChart(orders) {
      const ctx = document.getElementById('salesChart');
      if (!ctx) return;
      
      // Group by location
      const locationCounts = {};
      orders.forEach(order => {
        const loc = order.deliverylocation || order.deliveryLocation || 'Unknown';
        locationCounts[loc] = (locationCounts[loc] || 0) + 1;
      });
      
      // Filter: Remove locations with count below 3
      const filteredLocationCounts = {};
      Object.keys(locationCounts).forEach(loc => {
        if (locationCounts[loc] >= 3) {
          filteredLocationCounts[loc] = locationCounts[loc];
        }
      });
      
      if (salesChart) salesChart.destroy();
      
      salesChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(filteredLocationCounts),
          datasets: [{
            data: Object.values(filteredLocationCounts),
            backgroundColor: [
              '#667eea',
              '#764ba2',
              '#f093fb',
              '#f5576c',
              '#4facfe',
              '#00f2fe'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    function renderStockChart(inventory) {
      const ctx = document.getElementById('stockChart');
      if (!ctx) return;
      
      // Calculate current stock per warehouse (total, rounded)
      const warehouseStocks = {};
      CONFIG.WAREHOUSES.forEach(wh => {
        const totalStock = inventory.reduce((sum, p) => {
          return sum + (p.stock[wh] || 0);
        }, 0);
        warehouseStocks[wh] = Math.round(totalStock);
      });
      
      if (stockChart) stockChart.destroy();
      
      stockChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(warehouseStocks),
          datasets: [{
            label: 'Current Stock',
            data: Object.values(warehouseStocks),
            backgroundColor: '#667eea',
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                callback: function(value) {
                  return Math.round(value);
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Current Stock: ${Math.round(context.parsed.y)} units`;
                }
              }
            }
          }
        }
      });
    }
    
    function renderGaps(gaps) {
      const tbody = document.getElementById('gapsTable');
      if (!tbody) return;
      
      if (!gaps || gaps.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">No gaps found</td></tr>';
        return;
      }
      
      // Show top 5 gaps
      const topGaps = gaps.slice(0, 5);
      tbody.innerHTML = topGaps.map(gap => `
        <tr>
          <td>${gap.product || ''}</td>
          <td>${gap.location || ''}</td>
          <td><span class="badge bg-warning text-dark">${gap.pendingQty || 0}</span></td>
        </tr>
      `).join('');
    }
    
    function renderProcurement(gaps, inventory) {
      const tbody = document.getElementById('procurementTable');
      if (!tbody) return;
      
      // Aggregate gaps by product variant
      const procurementMap = {};
      gaps.forEach(gap => {
        const key = `${gap.product}_${gap.location}`;
        if (!procurementMap[key]) {
          procurementMap[key] = {
            product: gap.product,
            location: gap.location,
            qty: 0
          };
        }
        procurementMap[key].qty += parseInt(gap.pendingQty) || 0;
      });
      
      const procurementList = Object.values(procurementMap);
      
      if (procurementList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">No products to procure</td></tr>';
        return;
      }
      
      // Show top 5
      const topProcurement = procurementList.slice(0, 5);
      tbody.innerHTML = topProcurement.map(item => `
        <tr>
          <td>${item.product}</td>
          <td>${item.location}</td>
          <td><span class="badge bg-danger">${item.qty}</span></td>
        </tr>
      `).join('');
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>
</html>

